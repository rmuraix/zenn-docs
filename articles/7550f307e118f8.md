---
title: "Home Assistant Containerã‚’HTTPSã§å…¬é–‹ã™ã‚‹"
emoji: "ğŸ "
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Cloudflare", "homeassistant"]
published: true
---

## ã¯ã˜ã‚ã«

Home Assistantã‚’å¤–éƒ¨ã«å…¬é–‹ã™ã‚‹ã¨ã€è‡ªå®…ã®å¤–ã‚„Google Assistantãªã©ã‹ã‚‰åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚å…¬é–‹ã™ã‚‹æ–¹æ³•ã®1ã¤ã¨ã—ã¦ã€å…¬å¼ã§ã¯ã‚¢ãƒ‰ã‚ªãƒ³ã®DuckDNSã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•ãŒ[ç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã™](https://www.home-assistant.io/docs/configuration/securing/#remote-access)ã€‚ã—ã‹ã—ã€Home Assistant Containerã¯ã‚¢ãƒ‰ã‚ªãƒ³ã«[å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“](https://www.home-assistant.io/installation/#advanced-installation-methods)ã€‚ãã“ã§ã“ã®è¨˜äº‹ã§ã¯ã€æ¯”è¼ƒçš„ç°¡å˜ã«å…¬é–‹ãŒã§ãã‚‹Cloudflare Tunnelã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

## Cloudflare Tunnelã¨ã¯

Cloudflare Tunnelã¯ã‚µãƒ¼ãƒã‹ã‚‰ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰é€šä¿¡ã®ã¿ã§å¤–éƒ¨ã‹ã‚‰ã®å®‰å…¨ãªã‚µãƒ¼ãƒã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å®Ÿç¾ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚ã‚µãƒ¼ãƒä¸Šã§`cloudflared`ã¨ã„ã†è»½é‡ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã“ã¨ã«ã‚ˆã£ã¦æš—å·åŒ–ã•ã‚ŒãŸé€šä¿¡ã‚’æä¾›ã—ã¾ã™ã€‚
![](https://developers.cloudflare.com/assets/handshake_hufad68abf6107ffc2ef859ebe1b42b6e2_299675_1768x1102_resize_q75_box-3f75968f.jpg)
https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/

## Cloudflare Tunnelã®åˆæœŸè¨­å®š

### å‰ææ¡ä»¶

- Cloudflareã§ãƒ‰ãƒ¡ã‚¤ãƒ³åãŒç®¡ç†ã•ã‚Œã¦ã„ã‚‹

### æ‰‹é †

1. Cloudflareã®[Dashboard](https://dash.cloudflare.com/)ã®å·¦ãƒšã‚¤ãƒ³ã‹ã‚‰`Zero Trust`ã‚’ã‚¯ãƒªãƒƒã‚¯
2. `Networks`å†…ã®`Tunnels`ã‚’ã‚¯ãƒªãƒƒã‚¯
3. `Cerate a tunnel`ã‚’ã‚¯ãƒªãƒƒã‚¯
4. Select tunnel typeã§ã¯`Cloudflared`ã‚’é¸æŠ
   ![](https://storage.googleapis.com/zenn-user-upload/e11637d179b6-20240322.png)
5. Name your tunnelã§ã¯ã‚ã‹ã‚Šã‚„ã™ã„åå‰ã‚’å…¥åŠ›
   ![](https://storage.googleapis.com/zenn-user-upload/c40a8dd32dd9-20240322.png)
6. Install and run connectorsã§ã¯èµ·å‹•ã‚³ãƒãƒ³ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§æ§ãˆã¦ãŠãï¼ˆã“ã®ä¸­ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚ã¨ã§ä½¿ç”¨ã™ã‚‹ï¼‰
   ![](https://storage.googleapis.com/zenn-user-upload/c4cf8ae3c6c8-20240322.png)
7. Route Trafficã§ã¯ãƒ›ã‚¹ãƒˆåã¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¨­å®šã™ã‚‹
   ã‚µãƒ¼ãƒ“ã‚¹ã®Typeã¯`HTTP`ã€URLã¯Home Assistantã‚’è¨­ç½®ã™ã‚‹ã‚µãƒ¼ãƒã®ãƒ­ãƒ¼ã‚«ãƒ«IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒ‡å®šã™ã‚‹
   ![](https://storage.googleapis.com/zenn-user-upload/121a6d28e1e4-20240322.png)

## ãƒ‡ãƒ¼ãƒ¢ãƒ³ã®èµ·å‹•

Cloudflare Tunnelã®åˆæœŸè¨­å®šãŒå®Œäº†ã—ãŸã®ã§ã€cloudflaredã¨Home Assistantã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```yaml:docker-compose.yml
version: '3'
services:
  cloudflared:
    container_name: cloudflared
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
  homeassistant:
    container_name: homeassistant
    image: "ghcr.io/home-assistant/home-assistant:stable"
    volumes:
      - path/to/config:/config #è¦å¤‰æ›´
      - /etc/localtime:/etc/localtime:ro
      - /run/dbus:/run/dbus:ro
    restart: unless-stopped
    privileged: true
    network_mode: host
```

```bash:.env
CLOUDFLARE_TUNNEL_TOKEN= #ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å…¥åŠ›
```

https://www.home-assistant.io/installation/linux/#docker-compose

`docker compose up -d`ã§èµ·å‹•å¾Œã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ãƒˆãƒ³ãƒãƒ«ä¸€è¦§ã‚’è¦‹ã‚‹ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå¤‰ã‚ã£ã¦ã„ã¾ã™ã€‚

## Home Assistant Containerã®è¨­å®š

ãŸã èµ·å‹•ã—ãŸã ã‘ã§ã¯è¨­å®šã—ãŸãƒ›ã‚¹ãƒˆåã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚400ã‚¨ãƒ©ãƒ¼ãŒè¿”ã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯Home Assistantå´ãŒcloudflaredã‚’ä¿¡é ¼ã—ã¦ã„ãªã„ãŸã‚ã«ç™ºç”Ÿã™ã‚‹ã‚‚ã®ã§ã™ã€‚
Home Assistantã®`configuration.yaml`ã«ä»¥ä¸‹ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§è§£æ±ºã§ãã¾ã™ã€‚

```yaml:configuration.yaml
http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 172.20.0.2 #å„è‡ªç•°ãªã‚‹
```

https://www.home-assistant.io/integrations/http/#reverse-proxies

æŒ‡å®šã™ã‚‹ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯cloudflaredã®ã‚‚ã®ã§ã™ã€‚ãƒˆãƒ³ãƒãƒ«ä¸€è¦§ã‹ã‚‰è©²å½“ã®ãƒˆãƒ³ãƒãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦`Connector ID`ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå…ˆã§ç¢ºèªã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/4027f4ea9f1b-20240322.png)

è¨­å®šãŒå®Œäº†ã—ãŸã‚‰Home Assistantã®ã‚³ãƒ³ãƒ†ãƒŠã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„ã€‚
ã“ã“ã¾ã§è¡Œãˆã°è¨­å®šã—ãŸãƒ›ã‚¹ãƒˆåã¸æ­£ã—ãã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## æœ€å¾Œã«

Cloudflare Tunnelã‚’ä½¿ã£ã¦Home Assistant Containerã‚’HTTPSã§å…¬é–‹ã™ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã—ãŸã€‚Cloudflare Tunnelã¯Cloudflare Accessã¨ã„ã†ã‚¼ãƒ­ãƒˆãƒ©ã‚¹ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’å®Ÿç¾ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¨é€£æºã™ã‚‹ã“ã¨ã§ãƒãƒªã‚·ãƒ¼è¨­å®šãªã©ã¨ä½¿ã†ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ï¼ˆHome Assistantã®ã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒªã¨ä¸€éƒ¨ç›¸æ€§ãŒæ‚ªã„ï¼‰
é–“é•ã„ã‚’ç™ºè¦‹ã—ãŸéš›ã¯ã”æŒ‡æ‘˜ã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚
