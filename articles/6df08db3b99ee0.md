---
title: "MMAction2ã§RawFrameDatasetã‚’æ‰±ã†"
emoji: "ğŸ•º"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["æ©Ÿæ¢°å­¦ç¿’", "mmaction2", "åˆå¿ƒè€…"]
published: true
---

## ã¯ã˜ã‚ã«

[MMAction2](https://github.com/open-mmlab/mmaction2)ã®è¡Œå‹•èªè­˜ãƒ¢ãƒ‡ãƒ«ã§ã¯ã€`RawFrameDataset` ã¨`VideoDataset` ãŒä½¿ç”¨ã§ãã¾ã™ã€‚
ä»Šå›ã¯ã€3DCNNãƒ¢ãƒ‡ãƒ«ã§ã‚ã‚‹**I3D**ã®ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’`VideoDataset`ã‹ã‚‰`RawFrameDataset` ã«æ›¸ãæ›ãˆã‚‹ã“ã¨ã‚’é€šã—ã¦ã€`RawFrameDataset` ã®ä½¿ã„æ–¹ã‚’ç¢ºèªã—ã¾ã™ã€‚
ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã‹ã‚‰ç¢ºèªã§ãã¾ã™ã€‚
https://github.com/open-mmlab/mmaction2/blob/465d7debd3ff6b1e59ae9602fd186dc2297702b3/configs/recognition/i3d/i3d_imagenet-pretrained-r50_8xb8-32x2x1-100e_kinetics400-rgb.py

ãªãŠã€æ­£ç¢ºæ€§ã«ã¯ååˆ†æ°—ã‚’ã¤ã‘ã¦ã„ã¾ã™ãŒã€ç­†è€…ã¯ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ã§ã¯ãªã„ã®ã§é–“é•ã„ã‚’å«ã‚“ã§ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã‚’ã”äº†æ‰¿ãã ã•ã„ã€‚

## `VideoDataset`ã¨`RawFrameDataset`ã®é•ã„

MMAction2ã®è¡Œå‹•èªè­˜ãƒ¢ãƒ‡ãƒ«ã§ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’ä»¥ä¸‹ã®2ã¤ã®å½¢å¼ã§ä½¿ç”¨ã§ãã¾ã™ã€‚

- `VideoDataset`: å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„
- `RawFrameDataset`: å„å‹•ç”»ã‚’ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«åˆ†å‰²ã—ã€é€£ç•ªç”»åƒã¨ã—ã¦ç”¨æ„

## ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®ç”¨æ„

### å‹•ç”»ãƒ‡ãƒ¼ã‚¿

MMAction2ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ˆã‚‹ã¨ã€é€£ç•ªç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«é…ç½®ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã¯ä»»æ„ã§æ§‹ã„ã¾ã›ã‚“ãŒã€ç”»åƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯`img_00001.jpg`ã®å½¢å¼ã§ã™ã€‚

```
.
â”œâ”€â”€ video1
â”‚   â”œâ”€â”€ img_00001.jpg
â”‚   â”œâ”€â”€ img_00002.jpg
â”‚   â”œâ”€â”€ img_00003.jpg
â”‚   â””â”€â”€ ...
â”œâ”€â”€ video2
â”‚   â”œâ”€â”€ img_00001.jpg
â”‚   â”œâ”€â”€ img_00002.jpg
â”‚   â”œâ”€â”€ img_00003.jpg
â”‚   â””â”€â”€ ...
â”œâ”€â”€ video3
â”‚   â”œâ”€â”€ img_00001.jpg
â”‚   â”œâ”€â”€ img_00002.jpg
â”‚   â”œâ”€â”€ img_00003.jpg
â”‚   â””â”€â”€ ...
â””â”€â”€ ...

```

æ¬¡ã«ã€ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãæ›ãˆã¾ã™ã€‚

```diff python
- dataset_type = 'VideoDataset'
- data_root = 'data/kinetics400/videos_train'
- data_root_val = 'data/kinetics400/videos_val'
+ dataset_type = 'RawframeDataset'
+ data_root = 'path/to/your/data'
+ data_root_val = 'path/to/your/data'
```

:::message

`dataset_type`ã¯Raw**f**rameDatasetã¨ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
ä¸‹è¨˜ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒ—ã®èª¬æ˜ã§ã¯Raw**F**rameDatasetã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€æƒ‘ã‚ã•ã‚Œãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚

:::

https://mmaction2.readthedocs.io/en/latest/user_guides/prepare_dataset.html#action-recognition

### ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«

`Train`/`Val`/`Test`ç”¨ã®ãƒ©ãƒ™ãƒ«æƒ…å ±ã¯ã€ãã‚Œãã‚Œ`ann_file_train`ã€`ann_file_val`ã€`ann_file_test`å¤‰æ•°ã«æŒ‡å®šã—ã¾ã™ã€‚
ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã¯ã€`<ãƒ‘ã‚¹> <åˆè¨ˆãƒ•ãƒ¬ãƒ¼ãƒ æ•°> <ã‚¯ãƒ©ã‚¹>`ã®å½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ãƒ‘ã‚¹ã¯`data_root`ã¾ãŸã¯`data_root_val`ã‹ã‚‰ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚

```
some/video1 163 1
some/video2 122 1
some/video3 258 2
some/video4 234 2
some/video5 295 3
some/video6 121 3
```

æ¬¡ã«ã€ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ã¾ã™ã€‚ãƒ•ã‚¡ã‚¤ãƒ«åã¯ä»»æ„ã®åå‰ã§æ§‹ã„ã¾ã›ã‚“ã€‚

```diff python
- ann_file_train = 'data/kinetics400/kinetics400_train_list_videos.txt'
- ann_file_val = 'data/kinetics400/kinetics400_val_list_videos.txt'
- ann_file_test = 'data/kinetics400/kinetics400_val_list_videos.txt'
+ ann_file_train = 'path/to/your/ann_train.txt'
+ ann_file_val = 'path/to/your/ann_val.txt'
+ ann_file_test = 'path/to/your/ann_test.txt'
```

## pipelineã®å¤‰æ›´

ãƒ‡ãƒ¼ã‚¿æ‹¡å¼µãªã©ã‚’å®šç¾©ã—ã¦ã„ã‚‹`train_pipeline`/`val_pipeline`/`test_pipeline`ã‚’å¤‰æ›´ã—ã¾ã™ã€‚
`VideoDataset`ç”¨ã®`DecordInit`ã¨`DecordDecode`ã¯ä¸è¦ã§ã™ã€‚`DecordInit`ã¯å‰Šé™¤ã—ã€`DecordDecode`ã¯`RawFrameDecode`ã«ç½®ãæ›ãˆã¾ã™ã€‚

```diff python
train_pipeline = [
-   dict(type='DecordInit', **file_client_args),
    dict(type='SampleFrames', clip_len=32, frame_interval=2, num_clips=1),
-   dict(type='DecordDecode'),
+   dict(type="RawFrameDecode"),
    dict(type='Resize', scale=(-1, 256)),
    dict(
        type='MultiScaleCrop',
        input_size=224,
        scales=(1, 0.8),
        random_crop=False,
        max_wh_scale_gap=0),
    dict(type='Resize', scale=(224, 224), keep_ratio=False),
    dict(type='Flip', flip_ratio=0.5),
    dict(type='FormatShape', input_format='NCTHW'),
    dict(type='PackActionInputs')
]
# val_pipelineã¨test_pipelineã‚‚åŒæ§˜ã«
```

## dataloaderã®å¤‰æ›´

`train_dataloader`/`val_dataloader`/`test_dataloader`ã«ãŠã‘ã‚‹ã€`dataset`å†…ã®`data_prefix`ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```diff python
train_dataloader = dict(
    batch_size=8,
    num_workers=8,
    persistent_workers=True,
    sampler=dict(type='DefaultSampler', shuffle=True),
    dataset=dict(
        type=dataset_type,
        ann_file=ann_file_train,
-       data_prefix=dict(video=data_root),
+       data_prefix=dict(img=data_root),
        pipeline=train_pipeline))
# val_pipelineã¨test_pipelineã‚‚videoã‚’imgã«å¤‰æ›´ã™ã‚‹
```

ã“ã‚Œã‚’å¤‰æ›´ã—ãªã„ã¨ã€`KeyError: 'img'`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚

## ãã®ä»–ã®å¤‰æ›´

`RawFrameDataset`ã«é™ã£ãŸè©±ã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆãŒå¤‰ã‚ã£ã¦ã„ã‚‹ã®ã§ã‚¯ãƒ©ã‚¹æ•°ãªã©ã‚‚å¤‰æ›´ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚
ã‚¯ãƒ©ã‚¹æ•°ã¯ã€`configs/_base_/models/i3d_r50.py`ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ä¸Šæ›¸ãã—ã¾ã™ã€‚

```diff python
+ model = dict(
+   type="Recognizer3D",
+   backbone=dict(
+        type="ResNet3d",
+        pretrained2d=True,
+        pretrained="torchvision://resnet50",
+        depth=50,
+        conv1_kernel=(5, 7, 7),
+        conv1_stride_t=2,
+        pool1_stride_t=2,
+        conv_cfg=dict(type="Conv3d"),
+        norm_eval=False,
+        inflate=((1, 1, 1), (1, 0, 1, 0), (1, 0, 1, 0, 1, 0), (0, 1, 0)),
+        zero_init_residual=False,
+    ),
+    cls_head=dict(
+        type="I3DHead",
+        num_classes=400, #ã“ã“ã‚’å¤‰æ›´
+        in_channels=2048,
+        spatial_type="avg",
+        dropout_ratio=0.5,
+        init_std=0.01,
+        average_clips="prob",
+    ),
+    data_preprocessor=dict(
+        type="ActionDataPreprocessor",
+        mean=[123.675, 116.28, 103.53],
+        std=[58.395, 57.12, 57.375],
+        format_shape="NCTHW",
+    ),
+)
```

ãã®ä»–ã®è¨­å®šï¼ˆå­¦ç¿’æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ã‚„ãƒãƒƒãƒã‚µã‚¤ã‚ºãªã©ï¼‰ã‚‚ã€ç’°å¢ƒã‚„ç›®çš„ã«å¿œã˜ã¦é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

## æœ€å¾Œã«

ä»Šå›ã¯ã€MMAction2ã®I3Dãƒ¢ãƒ‡ãƒ«ã«ãŠã„ã¦`VideoDataset`ã‹ã‚‰`RawFrameDataset`ã¸ã¨ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã™ã‚‹æ‰‹é †ã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
æœ¬è¨˜äº‹ã‚’é€šã˜ã¦ã€è¨­å®šã®é•ã„ã‚„å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ›´æ–¹æ³•ã«é–¢ã™ã‚‹ç†è§£ãŒæ·±ã¾ã‚Šã€ä»Šå¾Œã®ãƒ¢ãƒ‡ãƒ«å®Ÿè£…ã‚„ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆè¨­å®šã«å½¹ç«‹ã¦ã‚‰ã‚Œã‚‹ã“ã¨ã‚’é¡˜ã£ã¦ã„ã¾ã™ã€‚
èª¤ã‚Šã‚„æ”¹å–„ç‚¹ãŒã‚ã‚Œã°ã€ãŠæ°—è»½ã«ã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚

## å‚è€ƒ

https://mmaction2.readthedocs.io/en/latest/user_guides/config.html
https://github.com/open-mmlab/mmaction2/issues/2713
